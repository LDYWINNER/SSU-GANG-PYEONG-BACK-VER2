FROM node:18.14.2 AS builder
RUN mkdir -p /app
WORKDIR /app
ADD . .

COPY package.json .

RUN npm uninstall bcrypt --force
RUN npm install bcrypt --force
RUN npm install --force
RUN npm run build

COPY . .

ARG STAGE
ENV STAGE ${STAGE}
ARG POSTGRES_HOST
ENV POSTGRES_HOST ${POSTGRES_HOST}
ARG DEFAULT_SALT
ENV DEFAULT_SALT ${DEFAULT_SALT}
ARG SENTRY_DSN
ENV SENTRY_DSN ${SENTRY_DSN}
ARG SLACK_WEBHOOK
ENV SLACK_WEBHOOK ${SLACK_WEBHOOK}
ARG EMAIL_USER
ENV EMAIL_USER ${EMAIL_USER}
ARG EMAIL_PASS
ENV EMAIL_PASS ${EMAIL_PASS}
ARG JWT_SECRET
ENV JWT_SECRET ${JWT_SECRET}
ARG JWT_LIFETIME
ENV JWT_LIFETIME ${JWT_LIFETIME}
ARG JWT_REFRESH_LIFETIME
ENV JWT_REFRESH_LIFETIME ${JWT_REFRESH_LIFETIME}
ARG SWAGGER_USER
ENV SWAGGER_USER ${SWAGGER_USER}
ARG SWAGGER_PASSWORD
ENV SWAGGER_PASSWORD ${SWAGGER_PASSWORD}

CMD npm run typeorm migration:run;npm run start:prod